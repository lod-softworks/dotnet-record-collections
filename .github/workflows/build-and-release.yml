name: Build & Release

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release Version Tag'
        required: true

jobs:
  build-and-release:
    runs-on: windows-latest
    environment: production

    steps:
    - uses: actions/checkout@v6

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 10.0.x

    - name: Set Version
      id: set-version
      shell: pwsh
      run: |
        if ("${{ github.event_name }}" -eq "release") {
          $version = "${{ github.event.release.tag_name }}"
          # Remove 'v' prefix if present (e.g., v1.0.0 -> 1.0.0)
          if ($version -match '^v(.+)$') {
            $version = $matches[1]
          }
        } else {
          $version = "${{ inputs.tag }}"
          # Remove 'v' prefix if present
          if ($version -match '^v(.+)$') {
            $version = $matches[1]
          }
        }
        Write-Host "Set version to: $version"
        echo "version=$version" >> $env:GITHUB_OUTPUT

    - name: Restore Dependencies
      run: dotnet restore ./src/Lod.RecordCollections.sln

    - name: Build
      run: |
        dotnet build ./src/Lod.RecordCollections/Lod.RecordCollections.csproj -c Release --no-restore -p:DebugType=portable -p:DebugSymbols=true -p:Version=${{ steps.set-version.outputs.version }} -p:AssemblyVersion=${{ steps.set-version.outputs.version }} -p:FileVersion=${{ steps.set-version.outputs.version }}
        dotnet build ./src/Lod.RecordCollections.IlAssembler/Lod.RecordCollections.IlAssembler.csproj -c Release --no-restore

    - name: Test
      run: dotnet test ./src/Lod.RecordCollections.Tests/Lod.RecordCollections.Tests.csproj -c Release --no-restore

    - name: IL Class/Record Conversion
      working-directory: ./src/Lod.RecordCollections.IlAssembler/bin/Release/net10.0
      run: |
        dotnet Lod.RecordCollections.IlAssembler.dll ../../../Lod.RecordCollections/bin/Release/netstandard2.0/Lod.RecordCollections.dll
        dotnet Lod.RecordCollections.IlAssembler.dll ../../../Lod.RecordCollections/bin/Release/net4.8/Lod.RecordCollections.dll
        dotnet Lod.RecordCollections.IlAssembler.dll ../../../Lod.RecordCollections/bin/Release/net8.0/Lod.RecordCollections.dll
        dotnet Lod.RecordCollections.IlAssembler.dll ../../../Lod.RecordCollections/bin/Release/net10.0/Lod.RecordCollections.dll

    - name: NuGet Pack
      run: dotnet pack ./src/Lod.RecordCollections/Lod.RecordCollections.csproj -c Release --no-restore --include-symbols --no-build -p:Version=${{ steps.set-version.outputs.version }} -p:PackageVersion=${{ steps.set-version.outputs.version }}

    - name: Test (Post-IL Modified)
      shell: pwsh
      run: |
        $config = "Release"
        $testOutBase = Join-Path "." "src/Lod.RecordCollections.IlModified.Tests/bin/$config"
        $libOutBase = Join-Path "." "src/Lod.RecordCollections/bin/$config"
        $tfms = @("net8.0", "net10.0", "net4.8")

        foreach ($tfm in $tfms) {
          $dest = Join-Path $testOutBase $tfm
          New-Item -ItemType Directory -Force -Path $dest | Out-Null
          Copy-Item (Join-Path $libOutBase "$tfm/Lod.RecordCollections.dll") (Join-Path $dest "Lod.RecordCollections.dll") -Force
        }

        dotnet test ./src/Lod.RecordCollections.IlModified.Tests/Lod.RecordCollections.IlModified.Tests.csproj -c Release -m:1 --framework net8.0 --no-restore --verbosity normal
        dotnet test ./src/Lod.RecordCollections.IlModified.Tests/Lod.RecordCollections.IlModified.Tests.csproj -c Release -m:1 --framework net10.0 --no-restore --verbosity normal
        dotnet test ./src/Lod.RecordCollections.IlModified.Tests/Lod.RecordCollections.IlModified.Tests.csproj -c Release -m:1 --framework net4.8 --no-restore --verbosity normal

    - name: NuGet Push
      run: dotnet nuget push ./src/Lod.RecordCollections/bin/Release/Lod.RecordCollections.${{ steps.set-version.outputs.version }}.nupkg --api-key ${{ secrets.NUGET_KEY }} -s https://api.nuget.org/v3/index.json
